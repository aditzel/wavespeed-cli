name: Test and Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: Install dependencies
      run: bun install
      
    - name: Run tests
      run: bun test
      
    - name: Build CLI
      run: bun run build
      
    - name: Test CLI executable
      run: ./dist/index.js --help
      
    - name: Verify CLI commands
      run: |
        ./dist/index.js generate --help
        ./dist/index.js edit --help
        ./dist/index.js generate-sequential --help
        ./dist/index.js edit-sequential --help

  validate-implementation:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: Install dependencies
      run: bun install
      
    - name: Build CLI
      run: bun run build
      
    - name: Test sync mode parameter
      run: |
        # Test that sync mode is available in all commands
        ./dist/index.js generate --help | grep -q "sync.*mode" || exit 1
        ./dist/index.js edit --help | grep -q "sync.*mode" || exit 1
        ./dist/index.js generate-sequential --help | grep -q "sync.*mode" || exit 1
        ./dist/index.js edit-sequential --help | grep -q "sync.*mode" || exit 1
        
    - name: Test file upload support
      run: |
        # Test that file path support is documented
        ./dist/index.js edit --help | grep -q "file paths" || exit 1
        ./dist/index.js edit-sequential --help | grep -q "file paths" || exit 1
        
    - name: Test parameter validation
      env:
        WAVESPEED_API_KEY: test-key
      run: |
        # Test validation without API calls
        ! ./dist/index.js edit 2>&1 | grep -q "Prompt is required" || echo "✓ Prompt validation works"
        ! ./dist/index.js edit -p "test" 2>&1 | grep -q "Images are required" || echo "✓ Images validation works"
        ! ./dist/index.js edit -p "test" -i "https://example.com/test.jpg" -s "invalid" 2>&1 | grep -q "Size must be WIDTH" || echo "✓ Size validation works"

  # Optional job for publishing (if you want to publish to npm)
  publish:
    runs-on: ubuntu-latest
    needs: [test, validate-implementation]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: Install dependencies
      run: bun install
      
    - name: Build CLI
      run: bun run build
      
    - name: Create release artifact
      run: |
        mkdir -p release
        cp dist/index.js release/wavespeed-cli
        chmod +x release/wavespeed-cli
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wavespeed-cli
        path: release/wavespeed-cli